---
title: "GPP-derived Phenology"
output: html_document
date: "2026-01-02"
---

```{r}
library(dplyr)
library(zoo)

#  phenological transition dates from daily GPP 
extract_GPP_phases <- function(df, threshold_percent = 0.25) {
  df <- df %>% filter(!is.na(GPP_mean)) 
  if (!"Year" %in% names(df)) return(data.frame(Year = NA, SOS25 = NA, EOS25 = NA, GSL = NA))
  if (nrow(df) < 100) return(data.frame(Year = unique(df$Year), SOS25 = NA, EOS25 = NA, GSL = NA))
  
  # LOESS smoothing of GPP
  loess_fit <- loess(GPP_mean ~ DOY, data = df, span = 0.2)
  df$GPP_smooth <- predict(loess_fit)
  
  # Calculate threshold based on seasonal amplitude
  gpp_min <- min(df$GPP_smooth, na.rm = TRUE)
  gpp_max <- max(df$GPP_smooth, na.rm = TRUE)
  amplitude <- gpp_max - gpp_min
  threshold_value <- gpp_min + threshold_percent * amplitude
  
  # Identify SOS25: first crossing above threshold in spring
  sos <- df %>%
    filter(DOY > 30 & DOY < 200 & GPP_smooth > threshold_value) %>%
    slice_head(n = 1) %>%
    pull(DOY)
  
  # Identify EOS25: last crossing above threshold in fall
  eos <- df %>%
    filter(DOY > 200 & DOY < 330 & GPP_smooth > threshold_value) %>%
    slice_tail(n = 1) %>%
    pull(DOY)
  
  # If either value is missing, return NA
  if (length(sos) == 0 || length(eos) == 0) {
    return(data.frame(Year = unique(df$Year), SOS25 = NA, EOS25 = NA, GSL = NA))
  }
  
  # Calculate growing season length
  gsl <- eos - sos
  
  # Return results
  return(data.frame(Year = unique(df$Year), SOS25 = sos, EOS25 = eos, GSL = gsl))
}

# ---- Prepare input data ----
phenologydaily <- daily_avg %>%
  mutate(
    Date = as.Date(Date),
    Year = as.numeric(format(Date, "%Y")),
    DOY = as.numeric(format(Date, "%j"))
  ) %>%
  filter(!is.na(GPP_mean))

# ---- Apply function across years ----
library(purrr)
gpp_pheno_results <- phenologydaily %>%
  group_split(Year) %>%
  purrr::map_dfr(~ extract_GPP_phases(.x))


# ---- Output the results ----
print(gpp_pheno_results)
write.csv(gpp_pheno_results, file = "~/Desktop/Bartlett_Datasets/gpp_pheno_resultsfromLOESS.csv")


# Checking results
ggplot(gpp_pheno_results, aes(x = Year, y = SOS25)) +
  geom_point() +
  geom_smooth(method = "lm", se = TRUE, color = "forestgreen") +
  labs(title = "Start of Season (SOS25) Over Time", y = "Day of Year", x = "Year")

lm_sos <- lm(SOS25 ~ Year, data = gpp_pheno_results)
summary(lm_sos)



ggplot(gpp_pheno_results, aes(x = Year, y = EOS25)) +
  geom_point() +
  geom_smooth(method = "lm", se = TRUE, color = "firebrick") +
  labs(title = "End of Season (EOS25) Over Time", y = "Day of Year", x = "Year")

lm_eos <- lm(EOS25 ~ Year, data = gpp_pheno_results)
summary(lm_eos)


ggplot(gpp_pheno_results, aes(x = Year, y = GSL)) +
  geom_point() +
  geom_smooth(method = "lm", se = TRUE, color = "steelblue") +
  labs(title = "Growing Season Length (GSL) Over Time", y = "Days", x = "Year")

lm_gsl <- lm(GSL ~ Year, data = gpp_pheno_results)
summary(lm_gsl)

```

