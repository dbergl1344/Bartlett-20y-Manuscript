---
title: "Meterological Trends"
output: html_document
date: "2025-12-30"
---

```{r}
library(dplyr)
library(broom)
library(knitr)

variables <- c("SWC_AverageNew", "P_1_1_1", "Tair", "TS_F_1_2_1", 
               "VPD", "CO2_mean", "PPFD_DIF_cumtotal_f", "PPFD_DIR_cumtotal_f")

# calculate slope, standard error, and p-value
calculate_trend <- function(data, variable) {
  if (variable %in% names(data)) {
    model <- lm(as.formula(paste(variable, "~ Year")), data = data)
    summary <- tidy(model)
    slope <- summary$estimate[2]    
    se <- summary$std.error[2]  
    p_value <- summary$p.value[2]    
    return(c(slope = slope, se = se, p_value = p_value))
  } else {
    return(c(slope = NA, se = NA, p_value = NA))
  }
}

# running stats
trend_results <- t(sapply(variables, calculate_trend, data = annual_avg_final))
trend_results <- as.data.frame(trend_results)
trend_results$Variable <- variables
colnames(trend_results) <- c("Slope_Year", "SE", "P_value", "Variable")

#  sig 
trend_results <- trend_results %>%
  mutate(Significance = case_when(
    P_value < 0.001 ~ "***",
    P_value < 0.01  ~ "**",
    P_value < 0.05  ~ "*",
    TRUE            ~ ""
  ))

# CI
trend_results <- trend_results %>%
  mutate(
    CI_lower = Slope_Year - 1.96 * SE,
    CI_upper = Slope_Year + 1.96 * SE
  )

# results
kable(trend_results, format = "pipe", digits = 4, align = 'c', 
      caption = "Annual Trends in Meteorological Variables (± SE and Significance)")

```


Checking MK for robustness. This script performs non-parametric Mann–Kendall trend tests and Sen’s slope estimates as a robustness check. Linear regression results (slopes ± SE, p-values) are reported in the manuscript.
```{r}
library(Kendall)
library(trend)

mk_variables <- c(
  "SWC_AverageNew",
  "P_1_1_1",
  "Tair",
  "TS_F_1_2_1",
  "VPD",
  "PPFD_DIF_cumtotal_f",
  "PPFD_DIR_cumtotal_f"
)

# mk and sens slope function
run_mk_test <- function(data, var) {
  
  y <- data[[var]]
  x <- data$Year
  if (all(is.na(y)) || length(unique(y[!is.na(y)])) < 3) {
    return(tibble(
      Variable    = var,
      MK_Tau      = NA_real_,
      MK_Pvalue   = NA_real_,
      Sen_Slope   = NA_real_
    ))
  }
  
  mk  <- MannKendall(y)
  sen <- sens.slope(y, x)
  
  tibble(
    Variable  = var,
    MK_Tau    = mk$tau[1],
    MK_Pvalue = mk$sl[1],
    Sen_Slope = sen$estimates[1]
  )
}

mk_results <- bind_rows(
  lapply(mk_variables, run_mk_test, data = annual_avg_final)
)

mk_results
```


