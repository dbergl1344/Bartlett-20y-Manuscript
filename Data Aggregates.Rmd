---
title: "Data Aggregates"
output: html_document
date: "2025-12-30"
---

# Daily data aggregation
```{r}
NewBart.df <- Bartlett30MinuteFluxData
library(dplyr)
library(lubridate) 

# correction factors across different timescales
MolarMass <- 12.01
SecondsPerHalfHour <- 1800
SecondsPerDay <- 3600 * 24
SecondsPerWeek <- SecondsPerDay * 7
SecondsPerMonth <- SecondsPerDay * 30.4375 
SecondsPerYear <- SecondsPerDay * 365.25

# daily averages
daily_avg <- NewBart.df %>%
  mutate(Date = as.Date(DateTime)) %>%
  group_by(Date) %>%
  summarise(
    across(c("Tair", "TS_F_1_2_1", "PPFD", "Rh", "WS_1_1_1", "SWC_1_1_1", "SWC_2_1_1", "SWC_3_1_1", "SWC_4_1_1", "VPD", "Rg", "NEE","SWC_AverageNew", "EVI", "DOY_cos", "DOY_sin", "Hour_cos", "Hour_sin", "PPFD_DIF_1_1_1", "PPFD_DIR_1_1_1", "PPFD_dir_f", "PPFD_diff_f"), mean, na.rm = TRUE),
    PPFD_cumtotal = sum(PPFD, na.rm = TRUE) * SecondsPerHalfHour,
    PPFD_DIF_cumtotal = sum(PPFD_DIF_1_1_1, na.rm = TRUE) * SecondsPerHalfHour,
    PPFD_DIR_cumtotal = sum(PPFD_DIR_1_1_1, na.rm = TRUE) * SecondsPerHalfHour,
    PPFD_DIF_cumtotal_f = sum(PPFD_dir_f, na.rm = TRUE) * SecondsPerHalfHour,
    PPFD_DIR_cumtotal_f = sum(PPFD_dir_f, na.rm = TRUE) * SecondsPerHalfHour,
    GPP_mean = mean(GPPU50, na.rm = TRUE) * 1e-6 * MolarMass * SecondsPerDay,
    Reco_mean = mean(RecoU50, na.rm = TRUE) * 1e-6 * MolarMass * SecondsPerDay,
    NEE_mean = mean(NEEU50_f, na.rm = TRUE) * 1e-6 * MolarMass * SecondsPerDay, 
    CO2_mean = mean(CO2_1_1_1, na.rm = TRUE), 
    P_1_1_1 = sum(P_1_1_1, na.rm = TRUE)
  )
```


# Weekly aggregate
```{r}
weekly_avg <- NewBart.df %>%
  mutate(Week = week(DateTime), Year = year(DateTime)) %>%
  group_by(Year, Week) %>%
  summarise(
     across(c("Tair", "TS_F_1_2_1", "PPFD", "Rh", "WS_1_1_1", "SWC_1_1_1", "SWC_2_1_1", "SWC_3_1_1", "SWC_4_1_1", "VPD", "Rg", "NEE", "SWC_AverageNew", "EVI", "DOY_cos", "DOY_sin", "Hour_cos", "Hour_sin", "PPFD_DIF_1_1_1", "PPFD_DIR_1_1_1", "PPFD_dir_f", "PPFD_diff_f"), mean, na.rm = TRUE),
    PPFD_cumtotal = sum(PPFD, na.rm = TRUE) * SecondsPerHalfHour,
    PPFD_DIF_cumtotal = sum(PPFD_DIF_1_1_1, na.rm = TRUE) * SecondsPerHalfHour,
    PPFD_DIR_cumtotal = sum(PPFD_DIR_1_1_1, na.rm = TRUE) * SecondsPerHalfHour,
    PPFD_DIF_cumtotal_f = sum(PPFD_dir_f, na.rm = TRUE) * SecondsPerHalfHour,
    PPFD_DIR_cumtotal_f = sum(PPFD_dir_f, na.rm = TRUE) * SecondsPerHalfHour,
    GPP_mean = mean(GPPU50, na.rm = TRUE) * 1e-6 * MolarMass * SecondsPerWeek,
    Reco_mean = mean(RecoU50, na.rm = TRUE) * 1e-6 * MolarMass * SecondsPerWeek,
    NEE_mean = mean(NEEU50_f, na.rm = TRUE) * 1e-6 * MolarMass * SecondsPerWeek, 
    CO2_mean = mean(CO2_1_1_1, na.rm = TRUE),
    P_1_1_1 = sum(P_1_1_1, na.rm = TRUE)
  )
```


# Monthly aggregate
```{r}
monthly_avg <- NewBart.df %>%
  mutate(Month = month(DateTime), Year = year(DateTime)) %>%
  group_by(Year, Month) %>%
  summarise(
    across(c("Tair", "TS_F_1_2_1", "PPFD", "Rh", "WS_1_1_1", "SWC_1_1_1", "SWC_2_1_1", "SWC_3_1_1", "SWC_4_1_1", "VPD", "Rg", "NEE", "SWC_AverageNew", "EVI", "DOY_cos", "DOY_sin", "Hour_cos", "Hour_sin", "PPFD_DIF_1_1_1", "PPFD_DIR_1_1_1", "PPFD_dir_f", "PPFD_diff_f"), mean, na.rm = TRUE),
    PPFD_cumtotal = sum(PPFD, na.rm = TRUE) * SecondsPerHalfHour,
    PPFD_DIF_cumtotal = sum(PPFD_DIF_1_1_1, na.rm = TRUE) * SecondsPerHalfHour,
    PPFD_DIR_cumtotal = sum(PPFD_DIR_1_1_1, na.rm = TRUE) * SecondsPerHalfHour,
    PPFD_DIF_cumtotal_f = sum(PPFD_dir_f, na.rm = TRUE) * SecondsPerHalfHour,
    PPFD_DIR_cumtotal_f = sum(PPFD_dir_f, na.rm = TRUE) * SecondsPerHalfHour,
    GPP_mean = mean(GPPU50, na.rm = TRUE) * 1e-6 * MolarMass * SecondsPerMonth,
    Reco_mean = mean(RecoU50, na.rm = TRUE) * 1e-6 * MolarMass * SecondsPerMonth,
    NEE_mean = mean(NEEU50_f, na.rm = TRUE) * 1e-6 * MolarMass * SecondsPerMonth, 
    CO2_mean = mean(CO2_1_1_1, na.rm = TRUE), 
    P_1_1_1 = sum(P_1_1_1, na.rm = TRUE)
  )
```


# Yearly aggregate
```{r}
annual_avg_final <- NewBart.df %>%
  mutate(Year = year(DateTime)) %>%
  group_by(Year) %>%
  summarise(
     across(c("Tair", "TS_F_1_2_1", "PPFD", "Rh", "WS_1_1_1", "SWC_1_1_1", "SWC_2_1_1", "SWC_3_1_1", "SWC_4_1_1", "VPD", "Rg", "NEE", "PPFD_DIF_1_1_1", "PPFD_DIR_1_1_1", "PPFD_dir_f", "PPFD_diff_f", "SWC_AverageNew", "EVI", "DOY_cos", "DOY_sin", "Hour_cos", "Hour_sin"), mean, na.rm = TRUE),
    PPFD_cumtotal = sum(PPFD, na.rm = TRUE) * SecondsPerHalfHour,
    PPFD_DIF_cumtotal = sum(PPFD_DIF_1_1_1, na.rm = TRUE) * SecondsPerHalfHour,
    PPFD_DIR_cumtotal = sum(PPFD_DIR_1_1_1, na.rm = TRUE) * SecondsPerHalfHour,
    PPFD_DIF_cumtotal_f = sum(PPFD_diff_f, na.rm = TRUE) * SecondsPerHalfHour,
    PPFD_DIR_cumtotal_f = sum(PPFD_dir_f, na.rm = TRUE) * SecondsPerHalfHour,
    GPP_mean = mean(GPPU50, na.rm = TRUE) * 1e-6 * MolarMass * SecondsPerYear,
    Reco_mean = mean(RecoU50, na.rm = TRUE) * 1e-6 * MolarMass * SecondsPerYear,
    NEE_mean = mean(NEEU50_f, na.rm = TRUE) * 1e-6 * MolarMass * SecondsPerYear, 
    CO2_mean = mean(CO2_1_1_1, na.rm = TRUE),
    P_1_1_1 = sum(P_1_1_1, na.rm = TRUE)
  )
```




# Annual Averages Across U05, U50 and U95
```{r}
annual_avg_finalUstars <- NewBart.df %>%
  mutate(Year = year(DateTime)) %>%
  group_by(Year) %>%
  summarise(
     across(c("Tair", "TS_F_1_2_1", "PPFD", "Rh", "WS_1_1_1", "SWC_1_1_1", "SWC_2_1_1", "SWC_3_1_1", "SWC_4_1_1", "VPD", "Rg", "NEE", "PPFD_DIF_1_1_1", "PPFD_DIR_1_1_1", "PPFD_dir_f", "PPFD_diff_f", "SWC_AverageNew", "EVI", "DOY_cos", "DOY_sin", "Hour_cos", "Hour_sin"), mean, na.rm = TRUE),
    GPP_mean = mean(GPPU50, na.rm = TRUE) * 1e-6 * MolarMass * SecondsPerYear,
    Reco_mean = mean(RecoU50, na.rm = TRUE) * 1e-6 * MolarMass * SecondsPerYear,
    NEE_mean = mean(NEEU50_f, na.rm = TRUE) * 1e-6 * MolarMass * SecondsPerYear, 
    GPP_meanU05 = mean(GPPU05, na.rm = TRUE) * 1e-6 * MolarMass * SecondsPerYear,
    Reco_meanU05 = mean(RecoU05, na.rm = TRUE) * 1e-6 * MolarMass * SecondsPerYear,
    NEE_meanU05 = mean(NEEU05_f, na.rm = TRUE) * 1e-6 * MolarMass * SecondsPerYear,
    GPP_meanU95 = mean(GPPU95, na.rm = TRUE) * 1e-6 * MolarMass * SecondsPerYear,
    Reco_meanU95 = mean(RecoU95, na.rm = TRUE) * 1e-6 * MolarMass * SecondsPerYear,
    NEE_meanU95 = mean(NEEU95_f, na.rm = TRUE) * 1e-6 * MolarMass * SecondsPerYear,
    CO2_mean = mean(CO2_1_1_1, na.rm = TRUE),
    P_1_1_1 = sum(P_1_1_1, na.rm = TRUE)
  )
```

